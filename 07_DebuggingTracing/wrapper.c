#define _GNU_SOURCE
#include <dlfcn.h>

#include <stdio.h>

typedef int (*orig_main_t)(int, char**, char**);
typedef void (*orig_fini_t)();

static orig_main_t orig_main;

#define _STR(x) #x
#define STR(x) _STR(x)

int new_main(int argc, char** argv, char** env)
{
#ifdef USE_LOGO
	printf("%s",
     		"\n"
		"                                                              @/(%%(#&%(*                                               \n"
		"                                                           @*(%#%@@@%@(@@@@                                             \n"
		"                                                        /*/%%&@*       @&%&@                                            \n"
		"                                     @(/*,,,/%.       #/*%#@/           @#&@              &@#(//(%&@&                   \n"
		"                                 @(*(&/%((((#/,.#   *(/%#@,             @%&@          &&#&@&/      #%@@#(&&             \n"
		"                              *@*/(         (*((**%,(#(&%     &@&@@&@   @%&@        &%@@*                @&%&&          \n"
		"                      ......(*(@*   ======    ,&/*@#%@@%    %/(( @#@   @@%@@       &&#                      &#@         \n"
		"                 ,*.......,.%@../   ======   ,.*&***/%(    */@@  @@@@@@@&&&       @/(#                      %##%        \n"
		"             /,,..... ... ..*#(*..          # @(/*.,%*      &@@( , %#@,(&%        &##%        #@@#           %%&        \n"
		"          ,*...,,,....*.....,,,#@(.*,,*..,*,.*#/.*/*(@#        @@@&&@@%            @&(&  #@@##@ ##\\         @%&        \n"
		"        /,,.**,,.,,,,,*.,,...,...,**,,##%%,*,,.,*/(##&(@                             @@%#% .# &@@@@        &%@@@        \n"
		"      #,,.*,*.,**,,,.**,,*,.,,,..* . ......,,,(/((&@@@%%(/@                                             @@@@@@(         \n"
		"     *******/##/((**,,*,,**,,,*,,,..*,*,*,**//((#(&%@@@&%%#((&*                                     *@@@@@@*            \n"
		"    ///*/(**(****((*/*/***(**//,***/,,,*(*/(/((%#&&@@@@@@@@@@&%%&/                              *@@@@@@@                \n"
		"   %(/#(/%/*(//*(*//((//**(//(//*((*/(//&#/*//#%(/#(%@@@@@&@@@@@@&&@&@                    %@@@@@@@@@,                   \n"
		"  ##@&%/*#(*&#(#(/,#/(*///((,*((/#(/((#(###*((/&%#(((#@@@@@@@@@@@@&@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@       .@@@@@@@@      \n"
		" (((/#/#((//((*(//##(%&&%&@@%(#(%#%#&##&##%###(&&%&#((#@%&#      %@@@@@@@@@@@@@@@@@@@@@@@@@@@@       /@@@@      &@@@@   \n"
		" %%#####&#(#(%((#%%@&(&&&%%&%&@@&@@@@@@@@#((#%%@@@&&%%##@@,            #@@@@@@@@@@@@@               @@@             @@@ \n"
		" %&%######%@%%@%%%%&@@%&%@%%@%@@@@        @(@@%#@@@%#(%#(#&&                                        @@@     @@ @     @@@\n"
		" @%%%%%@@%%@&@&%@%#&&@@&%&&@@@@          @&%@@&#@@@@@@@&%%%&@/                                       @@&     #@@     @@@\n"
		" &##%%&@&@#&&@@%&@%@@&@@@@@@@@       @@@&%@@@@(%@@@@@@@@@@@@&@@@                                        @@@@@@    ,@@@@ \n"
		"  %###%%%&@&&&&&@@@@@@@@@@@ .@@&@@@@@@@@@@@@@%@@@@@@@@@@@@@&@&@@@&@                                           /@@@@@@   \n"
		"    /&@@@@%@@@@@@@@@@@&@@@@@@@@@@@@@@@@@(@&#&@@@#        @@@@@@@@@@@@@@@*                            (@@@@@@@@@@@@      \n"
		"          &@@@&%@@@@@@@@@&@@@/          @@%%%@               @@@@@@@@@@@|   ______   _______   |@@@@@@@@@@@@@@          \n"
		"         &&@@                          @@@%@@    @@@@@@@@*@@@     *@@@@@|  (  __  \\ (  ____ \\  |@@@@@@*                 \n"
		"        %%%                           @@@@@@@  .@@          @@@         |  | (  \\  )| (    \\/  |                        \n"
		"       @&# @&%                        @@&@@@   @@  @@#/@&*   @@         |  | |   ) || (_____   |                        \n"
		"       %( %   @%                      @@@@@@   @@@ *.,@@#   @@@         |  | |   ) |      ) |  |                        \n"
		"       #@&@&@&&                         @@@@@@.  (@@@      @&@          |  | (__/  )/\\____) |  |                        \n"
		"                                          #@@@@@@@@@@@@@@@@@            |  (______/ \\_______)  |                        \n\n"
	);
#else
#ifdef WRAPPER_PRINT
	printf("%s\n", STR(WRAPPER_PRINT));
#else
    	printf("Main info: argc = %d\n", argc);
	for (int i = 0; i < argc; ++i)
		printf("\targ #%d: %s\n", i, argv[i]);
	printf("Enviroment:\n");
	int idx = 0;
	for (char** var = env; *var != NULL; var++, idx++)
		printf("\tenv #%d: %s\n", idx, *var);
	printf("\n");
#endif
#endif
	return orig_main(argc, argv, env);
}

int __libc_start_main(
		orig_main_t main, int argc, char** argv, 
		int(*init)(int, char**, char**),
	       	void (*fini)(void),
		void (*rtld_fini)(void),
		void *stack_end)
{
	orig_main = main;
	typeof(&__libc_start_main) orig_start_main = dlsym(RTLD_NEXT, "__libc_start_main");
	return orig_start_main(new_main, argc, argv, init, fini, rtld_fini, stack_end);
}	
